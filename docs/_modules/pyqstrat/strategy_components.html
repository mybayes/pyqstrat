<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyqstrat.strategy_components &#8212; pyqstrat 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <script src="../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyqstrat.strategy_components</h1><div class="highlight"><pre>
<span></span><span class="c1"># $$_ Lines starting with # $$_* autogenerated by jup_mini. Do not modify these</span>
<span class="c1"># $$_markdown</span>
<span class="c1"># # Strategy Components</span>
<span class="c1"># ## Purpose</span>
<span class="c1"># Helper components to build strategies with common use cases like VWAP entry and exit, and finite risk </span>
<span class="c1"># $$_end_markdown</span>
<span class="c1"># $$_code</span>
<span class="c1"># $$_ %%checkall</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">pyqstrat.account</span> <span class="kn">import</span> <span class="n">Account</span>
<span class="kn">from</span> <span class="nn">pyqstrat.pq_types</span> <span class="kn">import</span> <span class="n">Contract</span><span class="p">,</span> <span class="n">ContractGroup</span><span class="p">,</span> <span class="n">Trade</span><span class="p">,</span> <span class="n">Order</span><span class="p">,</span> <span class="n">VWAPOrder</span>
<span class="kn">from</span> <span class="nn">pyqstrat.pq_types</span> <span class="kn">import</span> <span class="n">MarketOrder</span><span class="p">,</span> <span class="n">LimitOrder</span><span class="p">,</span> <span class="n">TimeInForce</span>
<span class="kn">from</span> <span class="nn">pyqstrat.strategy</span> <span class="kn">import</span> <span class="n">PriceFunctionType</span><span class="p">,</span> <span class="n">StrategyContextType</span>
<span class="kn">from</span> <span class="nn">pyqstrat.pq_utils</span> <span class="kn">import</span> <span class="n">assert_</span><span class="p">,</span> <span class="n">get_child_logger</span><span class="p">,</span> <span class="n">np_indexof_sorted</span>


<span class="n">_logger</span> <span class="o">=</span> <span class="n">get_child_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="VectorIndicator">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VectorIndicator">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">VectorIndicator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    An indicator created from a vector</span>
<span class="sd">    Args:</span>
<span class="sd">        vector: Vector with indicator values. Must be the same length as strategy timestamps </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">vector</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        
<div class="viewcode-block" id="VectorIndicator.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VectorIndicator.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">contract_group</span><span class="p">:</span> <span class="n">ContractGroup</span><span class="p">,</span> 
                 <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                 <span class="n">indicator_values</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
                 <span class="n">context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector</span></div>
</div>



<div class="viewcode-block" id="VectorSignal">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VectorSignal">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">VectorSignal</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A signal created from a vector that has boolean values</span>
<span class="sd">    Args:</span>
<span class="sd">        vector: Vector with indicator values. Must be the same length as strategy timestamps </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">vector</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    
<div class="viewcode-block" id="VectorSignal.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VectorSignal.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">contract_group</span><span class="p">:</span> <span class="n">ContractGroup</span><span class="p">,</span> 
                 <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                 <span class="n">indicator_values</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
                 <span class="n">parent_values</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
                 <span class="n">context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector</span></div>
</div>


    
<div class="viewcode-block" id="get_contract_price_from_dict">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.get_contract_price_from_dict">[docs]</a>
<span class="k">def</span> <span class="nf">get_contract_price_from_dict</span><span class="p">(</span><span class="n">price_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> 
                                 <span class="n">contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span>
                                 <span class="n">timestamp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>               
    <span class="n">assert_</span><span class="p">(</span><span class="n">contract</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">price_dict</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">contract</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> not found in price_dict&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">price_dict</span><span class="p">[</span><span class="n">contract</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">ret</span></div>



<div class="viewcode-block" id="get_contract_price_from_array_dict">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.get_contract_price_from_array_dict">[docs]</a>
<span class="k">def</span> <span class="nf">get_contract_price_from_array_dict</span><span class="p">(</span><span class="n">price_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> 
                                       <span class="n">contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span> 
                                       <span class="n">timestamp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span>
                                       <span class="n">allow_previous</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">tup</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">price_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">contract</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">assert_</span><span class="p">(</span><span class="n">tup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">contract</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> not found in price_dict&#39;</span><span class="p">)</span>
    <span class="n">_timestamps</span><span class="p">,</span> <span class="n">_prices</span> <span class="o">=</span> <span class="n">tup</span>  <span class="c1"># type: ignore</span>
    <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span>
    <span class="k">if</span> <span class="n">allow_previous</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">_timestamps</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np_indexof_sorted</span><span class="p">(</span><span class="n">_timestamps</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>
<span class="c1">#     if idx &gt;= len(_prices):</span>
<span class="c1">#         import pdb</span>
<span class="c1">#         pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">_prices</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>  <span class="c1"># type: ignore</span></div>



<div class="viewcode-block" id="PriceFuncArrays">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PriceFuncArrays">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PriceFuncArrays</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A function object with a signature of PriceFunctionType. Takes three ndarrays</span>
<span class="sd">    of symbols, timestamps and prices</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">price_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>
    <span class="n">allow_previous</span><span class="p">:</span> <span class="nb">bool</span>
        
<div class="viewcode-block" id="PriceFuncArrays.__init__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PriceFuncArrays.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">allow_previous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">assert_</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">),</span>
                <span class="sa">f</span><span class="s1">&#39;arrays have different sizes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">price_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">symbols</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">symbols</span> <span class="o">==</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="n">price_dict</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">prices</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">price_dict</span> <span class="o">=</span> <span class="n">price_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_previous</span> <span class="o">=</span> <span class="n">allow_previous</span></div>

        
<div class="viewcode-block" id="PriceFuncArrays.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PriceFuncArrays.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">contract</span><span class="o">.</span><span class="n">is_basket</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_contract</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">contract</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">+=</span> <span class="n">get_contract_price_from_array_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_dict</span><span class="p">,</span> <span class="n">_contract</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_previous</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">get_contract_price_from_array_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_dict</span><span class="p">,</span> <span class="n">contract</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_previous</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">price</span></div>
</div>



<div class="viewcode-block" id="PriceFuncArrayDict">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PriceFuncArrayDict">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PriceFuncArrayDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A function object with a signature of PriceFunctionType and takes a dictionary of </span>
<span class="sd">        contract name -&gt; tuple of sorted timestamps and prices</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        price_dict: a dict with key=contract nane and value a tuple of timestamp and price arrays</span>
<span class="sd">        allow_previous: if set and we don&#39;t find an exact match for the timestamp, use the </span>
<span class="sd">            previous timestamp. Useful if you have a dict with keys containing dates instead of timestamps</span>
<span class="sd">        </span>
<span class="sd">    &gt;&gt;&gt; timestamps = np.arange(np.datetime64(&#39;2023-01-01&#39;), np.datetime64(&#39;2023-01-04&#39;))</span>
<span class="sd">    &gt;&gt;&gt; price_dict = {&#39;AAPL&#39;: (timestamps, [8, 9, 10]), &#39;IBM&#39;: (timestamps, [20, 21, 22])}</span>
<span class="sd">    &gt;&gt;&gt; pricefunc = PriceFuncArrayDict(price_dict)</span>
<span class="sd">    &gt;&gt;&gt; Contract.clear_cache()</span>
<span class="sd">    &gt;&gt;&gt; aapl = Contract.create(&#39;AAPL&#39;)</span>
<span class="sd">    &gt;&gt;&gt; assert(pricefunc(aapl, timestamps, 2, None) == 10)</span>
<span class="sd">    &gt;&gt;&gt; ibm = Contract.create(&#39;IBM&#39;)</span>
<span class="sd">    &gt;&gt;&gt; basket = Contract.create(&#39;AAPL_IBM&#39;, components=[(aapl, 1), (ibm, -1)])</span>
<span class="sd">    &gt;&gt;&gt; assert(pricefunc(basket, timestamps, 1, None) == -12)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">price_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>
    <span class="n">allow_previous</span><span class="p">:</span> <span class="nb">bool</span>
        
<div class="viewcode-block" id="PriceFuncArrayDict.__init__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PriceFuncArrayDict.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> <span class="n">allow_previous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_dict</span> <span class="o">=</span> <span class="n">price_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_previous</span> <span class="o">=</span> <span class="n">allow_previous</span></div>

        
<div class="viewcode-block" id="PriceFuncArrayDict.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PriceFuncArrayDict.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">contract</span><span class="o">.</span><span class="n">is_basket</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_contract</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">contract</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">+=</span> <span class="n">get_contract_price_from_array_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_dict</span><span class="p">,</span> <span class="n">_contract</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_previous</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">get_contract_price_from_array_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_dict</span><span class="p">,</span> <span class="n">contract</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_previous</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">price</span></div>
</div>

    
    
<div class="viewcode-block" id="PriceFuncDict">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PriceFuncDict">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PriceFuncDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A function object with a signature of PriceFunctionType and takes a dictionary of contract name -&gt; timestamp -&gt; price</span>
<span class="sd">    &gt;&gt;&gt; timestamps = np.arange(np.datetime64(&#39;2023-01-01&#39;), np.datetime64(&#39;2023-01-04&#39;))</span>
<span class="sd">    &gt;&gt;&gt; aapl_prices = [8, 9, 10]</span>
<span class="sd">    &gt;&gt;&gt; ibm_prices = [20, 21, 22]</span>
<span class="sd">    &gt;&gt;&gt; price_dict = {&#39;AAPL&#39;: {}, &#39;IBM&#39;: {}} </span>
<span class="sd">    &gt;&gt;&gt; for i, timestamp in enumerate(timestamps):</span>
<span class="sd">    ...    price_dict[&#39;AAPL&#39;][timestamp] = aapl_prices[i]</span>
<span class="sd">    ...    price_dict[&#39;IBM&#39;][timestamp] = ibm_prices[i]</span>
<span class="sd">    &gt;&gt;&gt; pricefunc = PriceFuncDict(price_dict)</span>
<span class="sd">    &gt;&gt;&gt; Contract.clear_cache()</span>
<span class="sd">    &gt;&gt;&gt; aapl = Contract.create(&#39;AAPL&#39;)</span>
<span class="sd">    &gt;&gt;&gt; assert(pricefunc(aapl, timestamps, 2, None) == 10)</span>
<span class="sd">    &gt;&gt;&gt; ibm = Contract.create(&#39;IBM&#39;)</span>
<span class="sd">    &gt;&gt;&gt; basket = Contract.create(&#39;AAPL_IBM&#39;, components=[(aapl, 1), (ibm, -1)])</span>
<span class="sd">    &gt;&gt;&gt; assert(pricefunc(basket, timestamps, 1, None) == -12)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">price_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
        
<div class="viewcode-block" id="PriceFuncDict.__init__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PriceFuncDict.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_dict</span> <span class="o">=</span> <span class="n">price_dict</span></div>

        
<div class="viewcode-block" id="PriceFuncDict.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PriceFuncDict.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">contract</span><span class="o">.</span><span class="n">is_basket</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_contract</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">contract</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">+=</span> <span class="n">get_contract_price_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_dict</span><span class="p">,</span> <span class="n">_contract</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">get_contract_price_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_dict</span><span class="p">,</span> <span class="n">contract</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">price</span></div>
</div>

    

<div class="viewcode-block" id="SimpleMarketSimulator">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.SimpleMarketSimulator">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SimpleMarketSimulator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A function object with a signature of MarketSimulatorType.</span>
<span class="sd">    It can take into account slippage and commission</span>
<span class="sd">    &gt;&gt;&gt; ContractGroup.clear_cache()</span>
<span class="sd">    &gt;&gt;&gt; Contract.clear_cache()</span>
<span class="sd">    &gt;&gt;&gt; put_symbol, call_symbol = &#39;SPX-P-3500-2023-01-19&#39;, &#39;SPX-C-4000-2023-01-19&#39;</span>
<span class="sd">    &gt;&gt;&gt; put_contract = Contract.create(put_symbol)</span>
<span class="sd">    &gt;&gt;&gt; call_contract = Contract.create(call_symbol)</span>
<span class="sd">    &gt;&gt;&gt; basket = Contract.create(&#39;test_contract&#39;)</span>
<span class="sd">    &gt;&gt;&gt; basket.components = [(put_contract, -1), (call_contract, 1)]</span>
<span class="sd">    &gt;&gt;&gt; timestamp = np.datetime64(&#39;2023-01-03 14:35&#39;)</span>
<span class="sd">    &gt;&gt;&gt; price_func = PriceFuncDict({put_symbol: {timestamp: 4.8}, call_symbol: {timestamp: 3.5}})</span>
<span class="sd">    &gt;&gt;&gt; order = MarketOrder(contract=basket, timestamp=timestamp, qty=10, reason_code=&#39;TEST&#39;)</span>
<span class="sd">    &gt;&gt;&gt; sim = SimpleMarketSimulator(price_func=price_func, slippage_pct=0)</span>
<span class="sd">    &gt;&gt;&gt; out = sim([order], 0, np.array([timestamp]), {}, {}, SimpleNamespace())</span>
<span class="sd">    &gt;&gt;&gt; assert(len(out) == 1)</span>
<span class="sd">    &gt;&gt;&gt; assert(math.isclose(out[0].price, -1.3))</span>
<span class="sd">    &gt;&gt;&gt; assert(out[0].qty == 10)    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">price_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span>
    <span class="n">slippage_pct</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">price_rounding</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">post_trade_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Trade</span><span class="p">,</span> <span class="n">StrategyContextType</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
        
<div class="viewcode-block" id="SimpleMarketSimulator.__init__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.SimpleMarketSimulator.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">price_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span><span class="p">,</span>
                 <span class="n">slippage_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
                 <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">price_rounding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                 <span class="n">post_trade_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Trade</span><span class="p">,</span> <span class="n">StrategyContextType</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Args:</span>
<span class="sd">            price_func: A function that we use to get the price to execute at</span>
<span class="sd">            slippage_pct: Slippage per dollar transacted. </span>
<span class="sd">                Meant to simulate the difference between bid/ask mid and execution price </span>
<span class="sd">            commission: Fee paid to broker per trade</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span> <span class="o">=</span> <span class="n">price_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage_pct</span> <span class="o">=</span> <span class="n">slippage_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">=</span> <span class="n">commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_rounding</span> <span class="o">=</span> <span class="n">price_rounding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_trade_func</span> <span class="o">=</span> <span class="n">post_trade_func</span></div>

    
<div class="viewcode-block" id="SimpleMarketSimulator.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.SimpleMarketSimulator.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">orders</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Order</span><span class="p">],</span>
                 <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                 <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                 <span class="n">indicators</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">],</span>
                 <span class="n">signals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">],</span>
                 <span class="n">strategy_context</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Trade</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;TODO: code for stop orders&#39;&#39;&#39;</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">MarketOrder</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">LimitOrder</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">contract</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">contract</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">contract</span><span class="o">.</span><span class="n">is_basket</span><span class="p">():</span> 
                <span class="n">raw_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy_context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">raw_price</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">_contract</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span> <span class="ow">in</span> <span class="n">contract</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                    <span class="n">raw_price</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span><span class="p">(</span><span class="n">_contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy_context</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">raw_price</span><span class="p">):</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">raw_price</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">slippage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage_pct</span> <span class="o">*</span> <span class="n">raw_price</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">qty</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">slippage</span> <span class="o">=</span> <span class="o">-</span><span class="n">slippage</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">raw_price</span> <span class="o">+</span> <span class="n">slippage</span>
            <span class="n">price</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_rounding</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">LimitOrder</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">limit_price</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">qty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">limit_price</span> <span class="o">&gt;</span> <span class="n">price</span><span class="p">)</span> 
                        <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">qty</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">limit_price</span> <span class="o">&lt;</span> <span class="n">price</span><span class="p">)):</span>
                    <span class="k">continue</span>
            <span class="n">commission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">*</span> <span class="n">order</span><span class="o">.</span><span class="n">qty</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">qty</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">commission</span> <span class="o">=</span> <span class="o">-</span><span class="n">commission</span>
            <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">contract</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">qty</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission</span><span class="p">)</span>
            <span class="n">order</span><span class="o">.</span><span class="n">fill</span><span class="p">()</span>
            <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_trade_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_trade_func</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">strategy_context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trades</span></div>
</div>

    

<div class="viewcode-block" id="PercentOfEquityTradingRule">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PercentOfEquityTradingRule">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PercentOfEquityTradingRule</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A rule that trades a percentage of equity.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        reason_code: Reason for entering the order, used for display</span>
<span class="sd">        equity_percent: Percentage of equity used to size order</span>
<span class="sd">        long: Whether We want to go long or short</span>
<span class="sd">        allocate_risk: If set, we divide the max risk by number of trades. Otherwise each trade will be alloated max risk </span>
<span class="sd">        limit_increment: If not nan, we add or subtract this number from current market price (if selling or buying respectively)</span>
<span class="sd">            and create a limit order. If nan, we create market orders</span>
<span class="sd">        price_func: The function we use to get intraday prices</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">reason_code</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">price_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span>
    <span class="n">equity_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># use 10% of equity by default</span>
    <span class="n">long</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">allocate_risk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">limit_increment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>
        
<div class="viewcode-block" id="PercentOfEquityTradingRule.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.PercentOfEquityTradingRule.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">contract_group</span><span class="p">:</span> <span class="n">ContractGroup</span><span class="p">,</span>
                 <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">indicator_values</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
                 <span class="n">signal_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">account</span><span class="p">:</span> <span class="n">Account</span><span class="p">,</span>
                 <span class="n">current_orders</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Order</span><span class="p">],</span>
                 <span class="n">strategy_context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
        
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
        <span class="n">contracts</span> <span class="o">=</span> <span class="n">contract_group</span><span class="o">.</span><span class="n">get_contracts</span><span class="p">()</span>
        <span class="n">orders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">contract</span> <span class="ow">in</span> <span class="n">contracts</span><span class="p">:</span>
            <span class="n">entry_price_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy_context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">entry_price_est</span><span class="p">):</span> <span class="k">return</span> <span class="p">[]</span>

            <span class="n">curr_equity</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">equity</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_percent</span> <span class="o">*</span> <span class="n">curr_equity</span>
            <span class="n">order_qty</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">entry_price_est</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate_risk</span><span class="p">:</span>
                <span class="n">order_qty</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contracts</span><span class="p">)</span>  <span class="c1"># divide up qty equally between all contracts</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">long</span><span class="p">:</span> <span class="n">order_qty</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">order_qty</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">order_qty</span><span class="p">)</span> <span class="k">if</span> <span class="n">order_qty</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">order_qty</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">order_qty</span><span class="p">,</span> <span class="mf">0.</span><span class="p">):</span> <span class="k">return</span> <span class="p">[]</span>
            
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_increment</span><span class="p">):</span>
                <span class="n">entry_price_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy_context</span><span class="p">)</span>
                <span class="n">entry_price_est</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">order_qty</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_increment</span>
                    
                <span class="n">limit_order</span> <span class="o">=</span> <span class="n">LimitOrder</span><span class="p">(</span><span class="n">contract</span><span class="o">=</span><span class="n">contract</span><span class="p">,</span>
                                         <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> 
                                         <span class="n">qty</span><span class="o">=</span><span class="n">order_qty</span><span class="p">,</span> 
                                         <span class="n">limit_price</span><span class="o">=</span><span class="n">entry_price_est</span><span class="p">,</span> 
                                         <span class="n">reason_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span><span class="p">)</span>
                <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limit_order</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">market_order</span> <span class="o">=</span> <span class="n">MarketOrder</span><span class="p">(</span><span class="n">contract</span><span class="o">=</span><span class="n">contract</span><span class="p">,</span> 
                                           <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                           <span class="n">qty</span><span class="o">=</span><span class="n">order_qty</span><span class="p">,</span> 
                                           <span class="n">reason_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span><span class="p">)</span> 
                <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">market_order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orders</span></div>
</div>

   

<div class="viewcode-block" id="VWAPEntryRule">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VWAPEntryRule">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">VWAPEntryRule</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A rule that generates VWAP orders</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        reason_code: Reason for each order. For display purposes</span>
<span class="sd">        vwap_minutes: How long the vwap period is. For example, a 5 minute vwap order will execute at 5 minute vwap </span>
<span class="sd">        from when it is sent to the market</span>
<span class="sd">        price_func: A function that this rule uses to get market price at a given timestamp</span>
<span class="sd">        long: Whether we want to go long or short</span>
<span class="sd">        percent_of_equity: Order qty is calculated so that if the stop price is reached, we lose this amount</span>
<span class="sd">        stop_price_ind: Don&#39;t enter if estimated entry price is </span>
<span class="sd">            market price &lt;= stop price + min_price_diff_pct * market_price (for long orders) or the opposite for short orders</span>
<span class="sd">        min_price_diff_pct: See stop_price_ind</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">reason_code</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">vwap_minutes</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">price_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span>
    <span class="n">long</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">percent_of_equity</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">stop_price_ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">min_price_diff_pct</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">single_entry_per_day</span><span class="p">:</span> <span class="nb">bool</span>
        
<div class="viewcode-block" id="VWAPEntryRule.__init__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VWAPEntryRule.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">reason_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">vwap_minutes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">price_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span><span class="p">,</span>
                 <span class="n">long</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">percent_of_equity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">stop_price_ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">min_price_diff_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">single_entry_per_day</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span> <span class="o">=</span> <span class="n">reason_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span> <span class="o">=</span> <span class="n">price_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long</span> <span class="o">=</span> <span class="n">long</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vwap_minutes</span> <span class="o">=</span> <span class="n">vwap_minutes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percent_of_equity</span> <span class="o">=</span> <span class="n">percent_of_equity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_price_ind</span> <span class="o">=</span> <span class="n">stop_price_ind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_price_diff_pct</span> <span class="o">=</span> <span class="n">min_price_diff_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single_entry_per_day</span> <span class="o">=</span> <span class="n">single_entry_per_day</span></div>

        
<div class="viewcode-block" id="VWAPEntryRule.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VWAPEntryRule.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">contract_group</span><span class="p">:</span> <span class="n">ContractGroup</span><span class="p">,</span>
                 <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">indicator_values</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
                 <span class="n">signal_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">account</span><span class="p">:</span> <span class="n">Account</span><span class="p">,</span>
                 <span class="n">current_orders</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Order</span><span class="p">],</span>
                 <span class="n">strategy_context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_entry_per_day</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;M8[D]&#39;</span><span class="p">)</span>
            <span class="n">trades</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">get_trades_for_date</span><span class="p">(</span><span class="n">contract_group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">):</span> <span class="k">return</span> <span class="p">[]</span>
            
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">current_orders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">contract_group</span> <span class="o">==</span> <span class="n">contract_group</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span> <span class="k">return</span> <span class="p">[]</span>

        <span class="n">orders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">contracts</span> <span class="o">=</span> <span class="n">contract_group</span><span class="o">.</span><span class="n">get_contracts</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">contract</span> <span class="ow">in</span> <span class="n">contracts</span><span class="p">:</span>
            <span class="n">entry_price_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy_context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">entry_price_est</span><span class="p">):</span> <span class="k">return</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_price_ind</span><span class="p">:</span>
                <span class="n">_stop_price_ind</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">indicator_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_price_ind</span><span class="p">)</span>
                <span class="n">stop_price</span> <span class="o">=</span> <span class="n">_stop_price_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">long</span> <span class="ow">and</span> <span class="p">(</span><span class="n">entry_price_est</span> <span class="o">-</span> <span class="n">stop_price</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_price_diff_pct</span> <span class="o">*</span> <span class="n">entry_price_est</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">long</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stop_price</span> <span class="o">-</span> <span class="n">entry_price_est</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_price_diff_pct</span> <span class="o">*</span> <span class="n">entry_price_est</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stop_price</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">curr_equity</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">equity</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">percent_of_equity</span> <span class="o">*</span> <span class="n">curr_equity</span>
            <span class="n">order_qty</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="p">(</span><span class="n">entry_price_est</span> <span class="o">-</span> <span class="n">stop_price</span><span class="p">)</span>
            <span class="n">order_qty</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contracts</span><span class="p">)</span>  <span class="c1"># divide up equity percentage equally</span>
            <span class="n">order_qty</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">order_qty</span><span class="p">)</span> <span class="k">if</span> <span class="n">order_qty</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">order_qty</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">order_qty</span><span class="p">,</span> <span class="mf">0.</span><span class="p">):</span> <span class="k">return</span> <span class="p">[]</span>
            <span class="n">vwap_end_time</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vwap_minutes</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">)</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">VWAPOrder</span><span class="p">(</span><span class="n">contract</span><span class="o">=</span><span class="n">contract</span><span class="p">,</span>
                              <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> 
                              <span class="n">vwap_stop</span><span class="o">=</span><span class="n">stop_price</span><span class="p">,</span>
                              <span class="n">vwap_end_time</span><span class="o">=</span><span class="n">vwap_end_time</span><span class="p">,</span> 
                              <span class="n">qty</span><span class="o">=</span><span class="n">order_qty</span><span class="p">,</span> 
                              <span class="n">time_in_force</span><span class="o">=</span><span class="n">TimeInForce</span><span class="o">.</span><span class="n">GTC</span><span class="p">,</span>
                              <span class="n">reason_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span><span class="p">)</span>
            <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">order</span><span class="p">]</span></div>
</div>

    
    
<div class="viewcode-block" id="VWAPCloseRule">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VWAPCloseRule">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">VWAPCloseRule</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Rule to close out a position at vwap price</span>
<span class="sd">    Args:</span>
<span class="sd">        reason_code: Reason_code: Reason for each order. For display purposes</span>
<span class="sd">        vwap_minutes: How long the vwap period is. For example, a 5 minute vwap order will execute at 5 minute vwap</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">reason_code</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">vwap_minutes</span><span class="p">:</span> <span class="nb">int</span>
        
<div class="viewcode-block" id="VWAPCloseRule.__init__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VWAPCloseRule.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">vwap_minutes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">reason_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vwap_minutes</span> <span class="o">=</span> <span class="n">vwap_minutes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span> <span class="o">=</span> <span class="n">reason_code</span></div>

        
<div class="viewcode-block" id="VWAPCloseRule.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VWAPCloseRule.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">contract_group</span><span class="p">:</span> <span class="n">ContractGroup</span><span class="p">,</span>
                 <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">indicator_values</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
                 <span class="n">signal_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">account</span><span class="p">:</span> <span class="n">Account</span><span class="p">,</span>
                 <span class="n">current_orders</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Order</span><span class="p">],</span>
                 <span class="n">strategy_context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">current_orders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">contract_group</span> <span class="o">==</span> <span class="n">contract_group</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span> <span class="k">return</span> <span class="p">[]</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">positions</span><span class="p">(</span><span class="n">contract_group</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="n">orders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
            <span class="c1"># assert len(positions) == 1, f&#39;expected 1 positions, got: {positions}&#39;</span>
            <span class="n">vwap_end_time</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vwap_minutes</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">)</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">VWAPOrder</span><span class="p">(</span><span class="n">contract</span><span class="o">=</span><span class="n">contract</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                              <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> 
                              <span class="n">vwap_end_time</span><span class="o">=</span><span class="n">vwap_end_time</span><span class="p">,</span> 
                              <span class="n">qty</span><span class="o">=-</span><span class="n">qty</span><span class="p">,</span> 
                              <span class="n">time_in_force</span><span class="o">=</span><span class="n">TimeInForce</span><span class="o">.</span><span class="n">GTC</span><span class="p">,</span>
                              <span class="n">reason_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span><span class="p">)</span>
            <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orders</span></div>
</div>



<div class="viewcode-block" id="VWAPMarketSimulator">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VWAPMarketSimulator">[docs]</a>
<span class="nd">@dataclass</span>    
<span class="k">class</span> <span class="nc">VWAPMarketSimulator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A market simulator that simulates buying and selling at VWAP prices.</span>
<span class="sd">    This works with VWAP orders and ignores all other order types</span>
<span class="sd">    The order executes either:</span>
<span class="sd">    a. After the vwap end time defined in the VWAP order</span>
<span class="sd">    b. If marker price &lt;= vwap stop price defined in the VWAP order for buy orders</span>
<span class="sd">    c. If market price &gt;= vwap stop price for sell orders</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">price_indicator</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">volume_indicator</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">backup_price_indicator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>

<div class="viewcode-block" id="VWAPMarketSimulator.__init__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VWAPMarketSimulator.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">price_indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">volume_indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">backup_price_indicator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Args:</span>
<span class="sd">            price_indicator: An indicator that contains historical trade price per timestamp</span>
<span class="sd">            volume_indicator: An indicator that contains volume per timestamp</span>
<span class="sd">            backup_price_indicator: Execution price to use if price or volume is missing</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_indicator</span> <span class="o">=</span> <span class="n">price_indicator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_indicator</span> <span class="o">=</span> <span class="n">volume_indicator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_price_indicator</span> <span class="o">=</span> <span class="n">backup_price_indicator</span></div>

    
<div class="viewcode-block" id="VWAPMarketSimulator.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.VWAPMarketSimulator.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">orders</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Order</span><span class="p">],</span> 
                 <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                 <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                 <span class="n">indicators</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ContractGroup</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">],</span>
                 <span class="n">signals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ContractGroup</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">],</span>
                 <span class="n">strategy_context</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Trade</span><span class="p">]:</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">VWAPOrder</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cg</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">contract_group</span>
            <span class="n">inds</span> <span class="o">=</span> <span class="n">indicators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cg</span><span class="p">)</span>
            <span class="n">assert_</span><span class="p">(</span><span class="n">inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;indicators not found for contract group: </span><span class="si">{</span><span class="n">cg</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">price_ind</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_indicator</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">assert_</span><span class="p">(</span><span class="n">price_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;indicator: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">price_indicator</span><span class="si">}</span><span class="s1"> not found for contract group: </span><span class="si">{</span><span class="n">cg</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">volume_ind</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_indicator</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">assert_</span><span class="p">(</span><span class="n">volume_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;indicator: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_indicator</span><span class="si">}</span><span class="s1"> not found for contract group: </span><span class="si">{</span><span class="n">cg</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">end_order</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">vwap_stop</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">qty</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">price_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">order</span><span class="o">.</span><span class="n">vwap_stop</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">qty</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">price_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">order</span><span class="o">.</span><span class="n">vwap_stop</span><span class="p">)):</span>
                <span class="n">end_order</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">end_order</span> <span class="ow">and</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">order</span><span class="o">.</span><span class="n">vwap_end_time</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;M8[D]&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;M8[D]&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">price_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">volume_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end_order</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">timestamps</span> <span class="o">&gt;=</span> <span class="n">order</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">timestamps</span> <span class="o">&lt;=</span> <span class="n">timestamp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">timestamps</span> <span class="o">&gt;=</span> <span class="n">order</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">timestamps</span> <span class="o">&lt;=</span> <span class="n">order</span><span class="o">.</span><span class="n">vwap_end_time</span><span class="p">)</span>
            <span class="n">amt</span> <span class="o">=</span> <span class="n">price_ind</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">volume_ind</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">amt</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">qty</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;using backup price for </span><span class="si">{</span><span class="n">cg</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> qty: </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">qty</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">assert_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_price_indicator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> 
                        <span class="sa">f</span><span class="s1">&#39;backup price indicator not found and no vwap found for: </span><span class="si">{</span><span class="n">cg</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">_backup_price_ind</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_price_indicator</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="n">assert_</span><span class="p">(</span><span class="n">_backup_price_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;backup price indicator not found for: </span><span class="si">{</span><span class="n">cg</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">vwap</span> <span class="o">=</span> <span class="n">_backup_price_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vwap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">amt</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">volume_ind</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
            <span class="n">assert_</span><span class="p">(</span><span class="n">vwap</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">fill_qty</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">qty</span>
            <span class="k">if</span> <span class="n">end_order</span><span class="p">:</span>
                <span class="n">fill_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">order</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">vwap_end_time</span> <span class="o">-</span> <span class="n">order</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
                <span class="n">fill_fraction</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fill_fraction</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">fill_qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">qty</span> <span class="o">*</span> <span class="n">fill_fraction</span><span class="p">)</span>
            <span class="n">order</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">fill_qty</span><span class="p">)</span>
            <span class="n">order</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">contract</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">fill_qty</span><span class="p">,</span> <span class="n">vwap</span><span class="p">)</span>
            <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trades</span></div>
</div>

    

<span class="n">ContractFilterType</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[</span>
    <span class="p">[</span><span class="n">ContractGroup</span><span class="p">,</span> 
     <span class="nb">int</span><span class="p">,</span> 
     <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
     <span class="n">SimpleNamespace</span><span class="p">,</span> 
     <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
     <span class="n">Account</span><span class="p">,</span> 
     <span class="n">Sequence</span><span class="p">[</span><span class="n">Order</span><span class="p">],</span>
     <span class="n">StrategyContextType</span><span class="p">],</span>
    <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>


<div class="viewcode-block" id="BracketOrderEntryRule">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.BracketOrderEntryRule">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BracketOrderEntryRule</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A rule that generates orders with stops</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        reason_code: Reason for the orders created used for display</span>
<span class="sd">        price_func: A function that returns price given a contract and timestamp</span>
<span class="sd">        long: whether we want to go long or short</span>
<span class="sd">        percent_of_equity: How much to risk per trade as a percentage of current equity.</span>
<span class="sd">            Used to calculate order qty so that if we get stopped out, we don&#39;t lose </span>
<span class="sd">            more than this amount. Of course if price gaps up or down rather than moving smoothly,</span>
<span class="sd">            we may lose more.</span>
<span class="sd">        stop_return_func: A function that gives us the distance between entry price and stop price</span>
<span class="sd">        min_stop_return: We will not enter if the stop_return is closer than this percent to the stop.</span>
<span class="sd">            Otherwise, we get very large trade sizes</span>
<span class="sd">        max_position_size: An order should not result in a position that is greater than this percent</span>
<span class="sd">            of the portfolio</span>
<span class="sd">        contract_filter: A function that takes similar arguments as a rule (with ContractGroup) replaced by </span>
<span class="sd">            Contract but returns a list of contract names for each positive signal timestamp. For example, </span>
<span class="sd">            for a strategy that trades 5000 stocks, you may want to construct a single signal and apply it </span>
<span class="sd">            to different contracts at different times, rather than create 5000 signals that will call your rule</span>
<span class="sd">            5000 times every time the signal is true.</span>
<span class="sd">            </span>
<span class="sd">    &gt;&gt;&gt; timestamps = np.arange(np.datetime64(&#39;2023-01-01&#39;), np.datetime64(&#39;2023-01-05&#39;))</span>
<span class="sd">    &gt;&gt;&gt; sig_values = np.full(len(timestamps), False) </span>
<span class="sd">    &gt;&gt;&gt; aapl_prices = np.array([100.1, 100.2, 100.3, 100.4])</span>
<span class="sd">    &gt;&gt;&gt; ibm_prices = np.array([200.1, 200.2, 200.3, 200.4])</span>
<span class="sd">    &gt;&gt;&gt; aapl_stops = np.array([-0.5, -0.3, -0.2, -0.01])</span>
<span class="sd">    &gt;&gt;&gt; ibm_stops=  np.array([-0.5, -0.3, -0.2, -0.15])</span>
<span class="sd">    &gt;&gt;&gt; price_dict = {&#39;AAPL&#39;: (timestamps, aapl_prices), &#39;IBM&#39;: (timestamps, ibm_prices)}</span>
<span class="sd">    &gt;&gt;&gt; stop_dict = {&#39;AAPL&#39;: (timestamps, aapl_stops), &#39;IBM&#39;: (timestamps, ibm_stops)}</span>
<span class="sd">    &gt;&gt;&gt; price_func = PriceFuncArrayDict(price_dict)</span>
<span class="sd">    &gt;&gt;&gt; fr = BracketOrderEntryRule(&#39;TEST_ENTRY&#39;, price_func, long=False)</span>
<span class="sd">    &gt;&gt;&gt; default_cg = ContractGroup.get(&#39;DEFAULT&#39;)</span>
<span class="sd">    &gt;&gt;&gt; default_cg.clear_cache()</span>
<span class="sd">    &gt;&gt;&gt; default_cg.add_contract(Contract.get_or_create(&#39;AAPL&#39;))</span>
<span class="sd">    &gt;&gt;&gt; default_cg.add_contract(Contract.get_or_create(&#39;IBM&#39;))</span>
<span class="sd">    &gt;&gt;&gt; account = SimpleNamespace()</span>
<span class="sd">    &gt;&gt;&gt; account.equity = lambda x: 1e6</span>
<span class="sd">    &gt;&gt;&gt; orders = fr(default_cg, 1, timestamps, SimpleNamespace(), sig_values, account, [], SimpleNamespace())</span>
<span class="sd">    &gt;&gt;&gt; assert len(orders) == 2 and orders[0].qty == -998 and orders[1].qty == -499</span>
<span class="sd">    &gt;&gt;&gt; stop_return_func = PriceFuncArrayDict(stop_dict)</span>
<span class="sd">    &gt;&gt;&gt; fr = BracketOrderEntryRule(&#39;TEST_ENTRY&#39;, price_func, long=True, stop_return_func=stop_return_func, min_stop_return=-0.1)</span>
<span class="sd">    &gt;&gt;&gt; orders = fr(default_cg, 2, timestamps, SimpleNamespace(), sig_values, account, [], SimpleNamespace())</span>
<span class="sd">    &gt;&gt;&gt; assert len(orders) == 2 and orders[0].qty == 4985 and orders[1].qty == 2496</span>
<span class="sd">    &gt;&gt;&gt; orders = fr(default_cg, 3, timestamps, SimpleNamespace(), sig_values, account, [], SimpleNamespace())</span>
<span class="sd">    &gt;&gt;&gt; assert len(orders) == 1 and orders[0].qty == 3326</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">reason_code</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">price_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span>
    <span class="n">long</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">percent_of_equity</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">min_stop_returnt</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">max_position_size</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">single_entry_per_day</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">contract_filter</span><span class="p">:</span> <span class="n">ContractFilterType</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">stop_return_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span> <span class="o">|</span> <span class="kc">None</span>

<div class="viewcode-block" id="BracketOrderEntryRule.__init__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.BracketOrderEntryRule.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">reason_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">price_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span><span class="p">,</span>
                 <span class="n">long</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">percent_of_equity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">min_stop_return</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">max_position_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">single_entry_per_day</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">contract_filter</span><span class="p">:</span> <span class="n">ContractFilterType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">stop_return_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span> <span class="o">=</span> <span class="n">reason_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span> <span class="o">=</span> <span class="n">price_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long</span> <span class="o">=</span> <span class="n">long</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percent_of_equity</span> <span class="o">=</span> <span class="n">percent_of_equity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_return_func</span> <span class="o">=</span> <span class="n">stop_return_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_stop_return</span> <span class="o">=</span> <span class="n">min_stop_return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_position_size</span> <span class="o">=</span> <span class="n">max_position_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single_entry_per_day</span> <span class="o">=</span> <span class="n">single_entry_per_day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_filter</span> <span class="o">=</span> <span class="n">contract_filter</span>        </div>


<div class="viewcode-block" id="BracketOrderEntryRule.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.BracketOrderEntryRule.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">contract_group</span><span class="p">:</span> <span class="n">ContractGroup</span><span class="p">,</span>
                 <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">indicator_values</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
                 <span class="n">signal_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">account</span><span class="p">:</span> <span class="n">Account</span><span class="p">,</span>
                 <span class="n">current_orders</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Order</span><span class="p">],</span>
                 <span class="n">strategy_context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;M8[D]&#39;</span><span class="p">)</span>

        <span class="n">contracts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Contract</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract_filter</span><span class="p">(</span>
                <span class="n">contract_group</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">indicator_values</span><span class="p">,</span> <span class="n">signal_values</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">current_orders</span><span class="p">,</span> <span class="n">strategy_context</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">_contract</span> <span class="o">=</span> <span class="n">Contract</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_contract</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">contracts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_contract</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">contracts</span> <span class="o">=</span> <span class="n">contract_group</span><span class="o">.</span><span class="n">get_contracts</span><span class="p">()</span>
            
        <span class="n">orders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">contract</span> <span class="ow">in</span> <span class="n">contracts</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_entry_per_day</span><span class="p">:</span>
                <span class="n">trades</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">get_trades_for_date</span><span class="p">(</span><span class="n">contract_group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">):</span> <span class="k">continue</span>
            
            <span class="n">entry_price_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy_context</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">entry_price_est</span><span class="p">):</span> <span class="k">continue</span>

            <span class="n">stop_price</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_return_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>           
                <span class="n">stop_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_return_func</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy_context</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="n">assert_</span><span class="p">(</span><span class="n">stop_return</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stop_return must be negative: </span><span class="si">{</span><span class="n">stop_return</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">contract</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stop_return</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_stop_return</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;entry price estimate: </span><span class="si">{</span><span class="n">entry_price_est</span><span class="si">}</span><span class="s1"> too close to stop price: </span><span class="si">{</span><span class="n">stop_price</span><span class="si">}</span><span class="s1">&#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39; min stop return: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_stop_return</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">long</span><span class="p">:</span> <span class="n">stop_return</span> <span class="o">=</span> <span class="o">-</span><span class="n">stop_return</span>
                <span class="n">stop_price</span> <span class="o">=</span> <span class="n">entry_price_est</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">stop_return</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">long</span> <span class="ow">and</span> <span class="n">entry_price_est</span> <span class="o">&lt;=</span> <span class="n">stop_price</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">long</span> <span class="ow">and</span> <span class="n">entry_price_est</span> <span class="o">&gt;=</span> <span class="n">stop_price</span><span class="p">)):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;entry price estimate: </span><span class="si">{</span><span class="n">entry_price_est</span><span class="si">}</span><span class="s1"> exceeds stop price: </span><span class="si">{</span><span class="n">stop_price</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>                                 

            <span class="n">curr_equity</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">equity</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">percent_of_equity</span> <span class="o">*</span> <span class="n">curr_equity</span>
            <span class="n">order_qty</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">entry_price_est</span> <span class="o">-</span> <span class="n">stop_price</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_position_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_qty</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_position_size</span> <span class="o">*</span> <span class="n">curr_equity</span> <span class="o">/</span> <span class="n">entry_price_est</span><span class="p">)</span>
                <span class="n">orig_qty</span> <span class="o">=</span> <span class="n">order_qty</span>
                <span class="k">if</span> <span class="n">max_qty</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">orig_qty</span><span class="p">):</span>
                    <span class="n">order_qty</span> <span class="o">=</span> <span class="n">max_qty</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">orig_qty</span><span class="p">)</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;max postion size exceeded: </span><span class="si">{</span><span class="n">contract</span><span class="si">}</span><span class="s1"> timestamp: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> max_qty: </span><span class="si">{</span><span class="n">max_qty</span><span class="si">}</span><span class="s1">&#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39; orig_qty: </span><span class="si">{</span><span class="n">orig_qty</span><span class="si">}</span><span class="s1"> new qty: </span><span class="si">{</span><span class="n">order_qty</span><span class="si">}</span><span class="s1"> max_qty: </span><span class="si">{</span><span class="n">max_qty</span><span class="si">}</span><span class="s1"> pos size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_position_size</span><span class="si">}</span><span class="s1">&#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39; curr_equity: </span><span class="si">{</span><span class="n">curr_equity</span><span class="si">}</span><span class="s1"> entry_price_est: </span><span class="si">{</span><span class="n">entry_price_est</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            <span class="n">order_qty</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">order_qty</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">long</span><span class="p">:</span> <span class="n">order_qty</span> <span class="o">=</span> <span class="o">-</span><span class="n">order_qty</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">order_qty</span><span class="p">,</span> <span class="mf">0.</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">MarketOrder</span><span class="p">(</span><span class="n">contract</span><span class="o">=</span><span class="n">contract</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                                <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> 
                                <span class="n">qty</span><span class="o">=</span><span class="n">order_qty</span><span class="p">,</span>
                                <span class="n">reason_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span><span class="p">)</span>
            <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orders</span></div>
</div>

    

<div class="viewcode-block" id="ClosePositionExitRule">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.ClosePositionExitRule">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ClosePositionExitRule</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A rule to close out an open position</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        reason_code: the reason for closing out used for display purposes</span>
<span class="sd">        price_func: the function this rule uses to get market prices</span>
<span class="sd">        limit_increment: if not nan, we add or subtract this number from current market price (if selling or buying respectively)</span>
<span class="sd">            and create a limit order</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">reason_code</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">price_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span>
    <span class="n">limit_increment</span><span class="p">:</span> <span class="nb">float</span>
        
<div class="viewcode-block" id="ClosePositionExitRule.__init__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.ClosePositionExitRule.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">reason_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">price_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span><span class="p">,</span>
                 <span class="n">limit_increment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span> <span class="o">=</span> <span class="n">reason_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span> <span class="o">=</span> <span class="n">price_func</span>
        <span class="n">assert_</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">limit_increment</span><span class="p">)</span> <span class="ow">or</span> <span class="n">limit_increment</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;limit_increment: </span><span class="si">{</span><span class="n">limit_increment</span><span class="si">}</span><span class="s1"> cannot be negative&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_increment</span> <span class="o">=</span> <span class="n">limit_increment</span></div>

        
<div class="viewcode-block" id="ClosePositionExitRule.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.ClosePositionExitRule.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">contract_group</span><span class="p">:</span> <span class="n">ContractGroup</span><span class="p">,</span>
                 <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">indicator_values</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
                 <span class="n">signal_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">account</span><span class="p">:</span> <span class="n">Account</span><span class="p">,</span>
                 <span class="n">current_orders</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Order</span><span class="p">],</span>
                 <span class="n">strategy_context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">positions</span><span class="p">(</span><span class="n">contract_group</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="n">orders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_increment</span><span class="p">):</span>
                <span class="n">exit_price_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy_context</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">qty</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">exit_price_est</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_increment</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exit_price_est</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_increment</span>
                <span class="n">limit_order</span> <span class="o">=</span> <span class="n">LimitOrder</span><span class="p">(</span><span class="n">contract</span><span class="o">=</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">qty</span><span class="o">=-</span><span class="n">qty</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="n">exit_price_est</span><span class="p">,</span> <span class="n">reason_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span><span class="p">)</span>
                <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limit_order</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">MarketOrder</span><span class="p">(</span><span class="n">contract</span><span class="o">=</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">qty</span><span class="o">=-</span><span class="n">qty</span><span class="p">,</span> <span class="n">reason_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span><span class="p">)</span>
            <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orders</span></div>
</div>

    

<div class="viewcode-block" id="StopReturnExitRule">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.StopReturnExitRule">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">StopReturnExitRule</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A rule that exits any given positions if a stop is hit.</span>
<span class="sd">    You should set entry_price in the strategy context in the market simulator when you enter a position</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">reason_code</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">price_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span>
    <span class="n">stop_return_func</span><span class="p">:</span> <span class="n">PriceFunctionType</span>

<div class="viewcode-block" id="StopReturnExitRule.__call__">
<a class="viewcode-back" href="../../pyqstrat.html#pyqstrat.strategy_components.StopReturnExitRule.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">contract_group</span><span class="p">:</span> <span class="n">ContractGroup</span><span class="p">,</span>
                 <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">indicator_values</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
                 <span class="n">signal_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">account</span><span class="p">:</span> <span class="n">Account</span><span class="p">,</span>
                 <span class="n">current_orders</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Order</span><span class="p">],</span>
                 <span class="n">context</span><span class="p">:</span> <span class="n">StrategyContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
        
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;M8[D]&#39;</span><span class="p">)</span>
        <span class="n">entry_prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">entry_prices</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>
        <span class="n">assert_</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entry_prices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;no symbols entered for: </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">positions</span><span class="p">(</span><span class="n">contract_group</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

        <span class="n">orders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">contract</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">symbol</span>
            <span class="n">stop_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_return_func</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">assert_</span><span class="p">(</span><span class="n">stop_ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stop_return must be negative: </span><span class="si">{</span><span class="n">stop_ret</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">entry_price</span> <span class="o">=</span> <span class="n">entry_prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">qty</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">stop_ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">stop_ret</span>
            <span class="n">stop_price</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">stop_ret</span><span class="p">)</span>
            <span class="n">curr_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_func</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">curr_price</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">qty</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">curr_price</span> <span class="o">&gt;</span> <span class="n">stop_price</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">qty</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">curr_price</span> <span class="o">&lt;</span> <span class="n">stop_price</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">MarketOrder</span><span class="p">(</span><span class="n">contract</span><span class="o">=</span><span class="n">contract</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">qty</span><span class="o">=-</span><span class="n">qty</span><span class="p">,</span> <span class="n">reason_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reason_code</span><span class="p">)</span>
            <span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orders</span></div>
</div>

    

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">optionflags</span><span class="o">=</span><span class="n">doctest</span><span class="o">.</span><span class="n">NORMALIZE_WHITESPACE</span> <span class="o">|</span> <span class="n">doctest</span><span class="o">.</span><span class="n">ELLIPSIS</span><span class="p">)</span>
<span class="c1"># $$_end_code</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">pyqstrat</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">pyqstrat</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Sal Abbasi.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>